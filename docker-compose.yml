services:
  backend:
    container_name: rickbot-api
    build:
      context: .
      dockerfile: Dockerfile.api
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GOOGLE_CLOUD_REGION=${GOOGLE_CLOUD_REGION}
      - LOG_LEVEL=${LOG_LEVEL}
      - APP_NAME=${APP_NAME}
      - AGENT_NAME=${AGENT_NAME}
      - GOOGLE_GENAI_USE_VERTEXAI=${GOOGLE_GENAI_USE_VERTEXAI}
      - MODEL=${MODEL}
      - AUTH_REQUIRED=${AUTH_REQUIRED}
      - RATE_LIMIT=${RATE_LIMIT}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/.config/gcloud/application_default_credentials.json
      - COMMIT_SHA=${COMMIT_SHA:-}
      - BACKEND_ALLOW_MOCK_AUTH=true # Enable mock auth for local docker dev
    volumes:
      - ./src:/app/src
      - ${HOME}/.config/gcloud:/app/.config/gcloud
    restart: unless-stopped

  frontend:
    container_name: rickbot-frontend
    build:
      context: src/nextjs_fe
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - NEXTAUTH_URL=http://localhost:3000
      - NEXTAUTH_SECRET=nzXsZfMELWdKaiAyh6eEsOGI0Jz0GOuSsqFrZhtNrDE= # Use dev secret
      - NEXT_PUBLIC_ALLOW_MOCK_AUTH=true
      - MOCK_AUTH_USER=mock@example.com
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
    restart: unless-stopped
    depends_on:
      - backend

  streamlit_fe:
    container_name: rickbot-streamlit-ui
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8501:8080"
    env_file:
      - .env
    environment:
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GOOGLE_CLOUD_REGION=${GOOGLE_CLOUD_REGION}
      - LOG_LEVEL=${LOG_LEVEL}
      - APP_NAME=${APP_NAME}
      - AGENT_NAME=${AGENT_NAME}
      - GOOGLE_GENAI_USE_VERTEXAI=${GOOGLE_GENAI_USE_VERTEXAI}
      - MODEL=${MODEL}
      - AUTH_REQUIRED=${AUTH_REQUIRED}
      - RATE_LIMIT=${RATE_LIMIT}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/.config/gcloud/application_default_credentials.json
      - COMMIT_SHA=${COMMIT_SHA:-}
      - MOCK_AUTH_USER=mock@example.com
    volumes:
      - ./src:/app/src
      - ${HOME}/.config/gcloud:/app/.config/gcloud
    restart: unless-stopped

  adk:
    container_name: rickbot-adk-web
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8081:8080"
    environment:
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GOOGLE_CLOUD_REGION=${GOOGLE_CLOUD_REGION}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/.config/gcloud/application_default_credentials.json
    volumes:
      - ./src:/app/src
      - ${HOME}/.config/gcloud:/app/.config/gcloud
    command: adk web --host 0.0.0.0 --port 8080 src